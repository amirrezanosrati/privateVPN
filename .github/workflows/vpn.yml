name: Ultra-Low Ping Gaming VPN
on:
  workflow_dispatch:

jobs:
  gaming-vpn:
    runs-on: ubuntu-latest
    steps:
    - name: Install requirements
      run: |
        sudo apt-get update
        sudo apt-get install -y softether-vpnserver

    - name: Setup Optimized VPN
      run: |
        # راه‌اندازی SoftEther با تنظیمات بهینه برای بازی
        sudo systemctl start softether-vpnserver
        
        sleep 5
        
        # ایجاد کاربر مخصوص بازی
        sudo vpncmd localhost:443 /SERVER /HUB:DEFAULT /CMD UserCreate gamer /GROUP: /REALNAME:Gaming\User /NOTE:For-Gaming
        sudo vpncmd localhost:443 /SERVER /HUB:DEFAULT /CMD UserPasswordSet gamer /PASSWORD:GamePass123!
        
        # تنظیمات بهینه برای پینگ پایین
        sudo vpncmd localhost:443 /SERVER /CMD ServerCipherSet ECDHE-P256
        sudo vpncmd localhost:443 /SERVER /CMD ServerCertRegenerate
        sudo vpncmd localhost:443 /SERVER /CMD KeepDisable
        sudo vpncmd localhost:443 /SERVER /CMD VpnOverIcmpDnsEnable /ICMP:yes /DNS:yes

    - name: Network Optimization
      run: |
        # بهینه‌سازی شبکه برای بازی
        echo "net.core.rmem_max = 2500000" | sudo tee -a /etc/sysctl.conf
        echo "net.core.wmem_max = 2500000" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_no_metrics_save = 1" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_low_latency = 1" | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p

    - name: Setup Ngrok UDP Tunnel
      run: |
        # دانلود ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # ایجاد تونل UDP برای پینگ پایین‌تر
        ./ngrok udp 500 --log=stdout > udp500.log 2>&1 &
        ./ngrok udp 4500 --log=stdout > udp4500.log 2>&1 &
        ./ngrok udp 1194 --log=stdout > udp1194.log 2>&1 &
        
        sleep 25

    - name: Get Connection Info
      run: |
        # دریافت بهترین تونل UDP
        UDP_TUNNEL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'udp://[^"]*' | head -1)
        
        UDP_IP=$(echo "$UDP_TUNNEL" | cut -d':' -f2 | sed 's#//##')
        UDP_PORT=$(echo "$UDP_TUNNEL" | cut -d':' -f3)
        
        echo "UDP_IP=$UDP_IP" >> $GITHUB_ENV
        echo "UDP_PORT=$UDP_PORT" >> $GITHUB_ENV

    - name: Display Gaming Optimized Config
      run: |
        echo "=========================================="
        echo "🎮 ULTRA-LOW PING GAMING VPN READY!"
        echo "=========================================="
        echo "📊 Protocol: UDP (Lowest Ping)"
        echo "🌐 Server: ${{ env.UDP_IP }}"
        echo "🔌 Port: ${{ env.UDP_PORT }}"
        echo "👤 Username: gamer"
        echo "🔑 Password: GamePass123!"
        echo "🔒 Encryption: AES-256-GCM"
        echo ""
        echo "⚡ Recommended for:"
        echo "• Mobile Legends"
        echo "• PUBG Mobile"
        echo "• Call of Duty Mobile"
        echo "• Free Fire"
        echo ""
        echo "📱 Connection Type: L2TP/IPsec PSK"
        echo "=========================================="

    - name: Continuous Ping Test
      run: |
        echo "🏓 Starting continuous ping test..."
        echo "📊 Monitoring connection quality..."
        
        while true; do
            # تست پینگ به سرورهای بازی
            echo "=========================================="
            echo "🎯 PING TEST - $(date +'%H:%M:%S')"
            echo "=========================================="
            
            # تست پینگ به سرورهای مختلف
            echo "Mobile Legends:"
            ping -c 2 mlbb.com | tail -1 | awk '{print $4}' | cut -d'/' -f2 || echo "N/A"
            
            echo "Google DNS:"
            ping -c 2 8.8.8.8 | tail -1 | awk '{print $4}' | cut -d'/' -f2 || echo "N/A"
            
            echo "Cloudflare:"
            ping -c 2 1.1.1.1 | tail -1 | awk '{print $4}' | cut -d'/' -f2 || echo "N/A"
            
            sleep 30
        done
