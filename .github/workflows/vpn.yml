name: Ultra-Low Ping Gaming VPN
on:
  workflow_dispatch:

jobs:
  gaming-vpn:
    runs-on: ubuntu-latest
    steps:
    - name: Install requirements
      run: |
        sudo apt-get update
        sudo apt-get install -y softether-vpnserver

    - name: Setup Optimized VPN
      run: |
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SoftEther
        sudo systemctl start softether-vpnserver
        sleep 5
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒ
        sudo vpncmd localhost:443 /SERVER /HUB:DEFAULT /CMD UserCreate gamer /GROUP: /REALNAME:Gaming\User /NOTE:For-Gaming
        sudo vpncmd localhost:443 /SERVER /HUB:DEFAULT /CMD UserPasswordSet gamer /PASSWORD:GamePass123!
        
        # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙ†Ú¯ Ù¾Ø§ÛŒÛŒÙ† (Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§)
        sudo vpncmd localhost:443 /SERVER /CMD ServerCipherSet ECDHE-P256
        sudo vpncmd localhost:443 /SERVER /CMD KeepDisable
        sudo vpncmd localhost:443 /SERVER /CMD VpnOverIcmpDnsEnable /ICMP:yes /DNS:yes

    - name: Network Optimization
      run: |
        # Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¨Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
        echo "net.core.rmem_max = 2500000" | sudo tee -a /etc/sysctl.conf
        echo "net.core.wmem_max = 2500000" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_no_metrics_save = 1" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_low_latency = 1" | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p

    - name: Setup Ngrok UDP Tunnel
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ†Ù„ UDP Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙ†Ú¯ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±
        ./ngrok udp 500 --log=stdout > udp500.log 2>&1 &
        ./ngrok udp 4500 --log=stdout > udp4500.log 2>&1 &
        ./ngrok udp 1194 --log=stdout > udp1194.log 2>&1 &
        
        sleep 25

    - name: Get Connection Info
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø¨Ù‡ØªØ±ÛŒÙ† ØªÙˆÙ†Ù„ UDP
        UDP_TUNNEL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'udp://[^"]*' | head -1)
        
        if [ -n "$UDP_TUNNEL" ]; then
            UDP_IP=$(echo "$UDP_TUNNEL" | cut -d':' -f2 | sed 's#//##')
            UDP_PORT=$(echo "$UDP_TUNNEL" | cut -d':' -f3)
        else
            # Fallback Ø¨Ù‡ TCP Ø§Ú¯Ø± UDP Ú©Ø§Ø± Ù†Ú©Ø±Ø¯
            TCP_TUNNEL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
            UDP_IP=$(echo "$TCP_TUNNEL" | cut -d':' -f2 | sed 's#//##')
            UDP_PORT=$(echo "$TCP_TUNNEL" | cut -d':' -f3)
        fi
        
        echo "UDP_IP=$UDP_IP" >> $GITHUB_ENV
        echo "UDP_PORT=$UDP_PORT" >> $GITHUB_ENV

    - name: Display Gaming Optimized Config
      run: |
        echo "=========================================="
        echo "ğŸ® ULTRA-LOW PING GAMING VPN READY!"
        echo "=========================================="
        echo "ğŸ“Š Protocol: UDP (Lowest Ping)"
        echo "ğŸŒ Server: ${{ env.UDP_IP }}"
        echo "ğŸ”Œ Port: ${{ env.UDP_PORT }}"
        echo "ğŸ‘¤ Username: gamer"
        echo "ğŸ”‘ Password: GamePass123!"
        echo "ğŸ”’ Encryption: ECDHE-P256"
        echo ""
        echo "âš¡ Optimized for:"
        echo "â€¢ Mobile Legends"
        echo "â€¢ PUBG Mobile" 
        echo "â€¢ Call of Duty Mobile"
        echo ""
        echo "ğŸ“± Connection Type: L2TP/IPsec PSK"
        echo "=========================================="

    - name: Continuous Ping Test
      run: |
        echo "ğŸ“ Starting continuous ping test..."
        echo "ğŸ“Š Monitoring connection quality..."
        
        while true; do
            # ØªØ³Øª Ù¾ÛŒÙ†Ú¯ Ø¨Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
            echo "=========================================="
            echo "ğŸ¯ PING TEST - $(date +'%H:%M:%S')"
            echo "=========================================="
            
            # ØªØ³Øª Ù¾ÛŒÙ†Ú¯ Ø¨Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            echo "Mobile Legends:"
            ping -c 2 mlbb.com | tail -1 | awk -F'/' '{print $5 " ms"}' || echo "N/A"
            
            echo "Google DNS:"
            ping -c 2 8.8.8.8 | tail -1 | awk -F'/' '{print $5 " ms"}' || echo "N/A"
            
            echo "Cloudflare:"
            ping -c 2 1.1.1.1 | tail -1 | awk -F'/' '{print $5 " ms"}' || echo "N/A"
            
            sleep 30
        done
